<ui:FluentWindow x:Class="DevKill.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:tray="http://schemas.lepo.co/wpfui/2022/xaml/tray"
        xmlns:vm="clr-namespace:DevKill.ViewModels"
        xmlns:conv="clr-namespace:DevKill.Converters"
        Title="DevKill"
        Width="1100" Height="650"
        MinWidth="750" MinHeight="400"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="None"
        Background="{DynamicResource ApplicationBackgroundBrush}">

    <ui:FluentWindow.Resources>
        <conv:ProtocolBrushConverter x:Key="ProtocolBrushConverter" />
        <Style x:Key="ProtocolBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="6,2" />
            <Setter Property="HorizontalAlignment" Value="Left" />
        </Style>
    </ui:FluentWindow.Resources>

    <ui:FluentWindow.InputBindings>
        <KeyBinding Key="F5" Command="{Binding RefreshAsyncCommand}" />
        <KeyBinding Key="K" Modifiers="Ctrl" Command="{Binding FocusSearchCommand, RelativeSource={RelativeSource AncestorType=ui:FluentWindow}}" />
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding FocusSearchCommand, RelativeSource={RelativeSource AncestorType=ui:FluentWindow}}" />
    </ui:FluentWindow.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title bar -->
        <ui:TitleBar Grid.Row="0" Title="DevKill" ShowMaximize="True" ShowMinimize="True" />

        <!-- Toolbar -->
        <Grid Grid.Row="1" Margin="16,8,16,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <ui:TextBox x:Name="SearchBox"
                        Grid.Column="0"
                        PlaceholderText="Filter by port, name, PID..."
                        Icon="{ui:SymbolIcon Search24}"
                        Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"
                        Margin="0,0,8,0" />

            <ui:Button Grid.Column="1"
                       x:Name="BulkKillButton"
                       Appearance="Danger"
                       Content="Kill Selected"
                       Icon="{ui:SymbolIcon Delete24}"
                       Click="BulkKill_Click"
                       Visibility="Collapsed"
                       Margin="0,0,8,0" />

            <ui:Button Grid.Column="2"
                       Content="Refresh"
                       Icon="{ui:SymbolIcon ArrowSync24}"
                       Command="{Binding RefreshAsyncCommand}"
                       Margin="0,0,8,0" />

            <CheckBox Grid.Column="3"
                      Content="Start with Windows"
                      IsChecked="{Binding AutoStartEnabled, Mode=OneWay}"
                      Command="{Binding ToggleAutoStartCommand}" />

            <ui:Button Grid.Column="4"
                       Content="Quit"
                       Icon="{ui:SymbolIcon Power24}"
                       Click="Quit_Click"
                       Margin="8,0,0,0" />
        </Grid>

        <!-- DataGrid -->
        <DataGrid Grid.Row="2"
                  x:Name="PortGrid"
                  ItemsSource="{Binding EntriesView}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  SelectionMode="Extended"
                  SelectionChanged="PortGrid_SelectionChanged"
                  GridLinesVisibility="None"
                  HeadersVisibility="Column"
                  CanUserReorderColumns="True"
                  CanUserSortColumns="True"
                  CanUserResizeColumns="True"
                  Background="Transparent"
                  BorderThickness="0"
                  HorizontalScrollBarVisibility="Disabled"
                  SizeChanged="PortGrid_SizeChanged"
                  LoadingRow="PortGrid_LoadingRow"
                  Margin="16,0,16,0">

            <DataGrid.GroupStyle>
                <GroupStyle>
                    <GroupStyle.HeaderTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="4,8,0,4">
                                <TextBlock Text="{Binding Name}"
                                           FontWeight="SemiBold"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                                <TextBlock Text="{Binding ItemCount, StringFormat=' ({0})'}"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Margin="4,0,0,0" />
                            </StackPanel>
                        </DataTemplate>
                    </GroupStyle.HeaderTemplate>
                </GroupStyle>
            </DataGrid.GroupStyle>

            <DataGrid.Columns>
                <DataGridTextColumn Header="Port" Binding="{Binding Port}" Width="80"
                                    ElementStyle="{StaticResource {x:Type TextBlock}}" />

                <DataGridTemplateColumn Header="Protocol" Width="85">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Border Style="{StaticResource ProtocolBadge}"
                                    Background="{Binding Protocol, Converter={StaticResource ProtocolBrushConverter}}">
                                <TextBlock Text="{Binding Protocol}"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Foreground="Black" />
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="PID" Binding="{Binding Pid}" Width="80" />
                <DataGridTextColumn Header="Process" Binding="{Binding ProcessName}" Width="150" />
                <DataGridTextColumn x:Name="PathColumn" Header="Directory" Binding="{Binding DisplayPath}" Width="200">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTemplateColumn Header="" Width="70">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ui:Button Content="Kill"
                                       Appearance="Danger"
                                       Command="{Binding KillCommand}"
                                       Padding="10,2"
                                       FontSize="12" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Snackbar -->
        <ui:SnackbarPresenter x:Name="SnackbarPresenter" Grid.Row="2" VerticalAlignment="Bottom" />

        <!-- Status bar -->
        <Border Grid.Row="3" Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                    <Run Text="{Binding DevCount, Mode=OneWay}" />
                    <Run Text="dev servers" />
                    <Run Text=" | " />
                    <Run Text="{Binding TotalCount, Mode=OneWay}" />
                    <Run Text="total ports" />
                </TextBlock>

                <TextBlock Grid.Column="1"
                           Text="Auto-refreshing every 3s"
                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                           FontSize="11" />
            </Grid>
        </Border>

        <!-- System Tray -->
        <tray:NotifyIcon Grid.Row="0"
                         x:Name="TrayIcon"
                         TooltipText="DevKill"
                         Icon="pack://application:,,,/Assets/devkill.ico"
                         LeftDoubleClick="TrayIcon_LeftDoubleClick"
                         MenuOnRightClick="True">
            <tray:NotifyIcon.Menu>
                <ContextMenu x:Name="TrayContextMenu" Opened="TrayContextMenu_Opened">
                    <MenuItem Header="Show DevKill" Click="TrayShowWindow_Click" FontWeight="Bold" />
                    <Separator />
                    <MenuItem Header="Exit" Click="TrayExit_Click" />
                </ContextMenu>
            </tray:NotifyIcon.Menu>
        </tray:NotifyIcon>
    </Grid>
</ui:FluentWindow>
